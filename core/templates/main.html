{% extends "_base.html" %}
{% load staticfiles %}
{#{% block page_title %} VAP {% endblock %}#}
{#{% block subtitle %}Visual analytics platform home{% endblock %}#}

{% block extra_css %}{% endblock %}

{% block body %}
    {% csrf_token %}
  <div class="card text-white bg-dark mb-3">
  <div class="card-body">
    <h2 class="card-title">InVEx for ATLAS</h2>
      <h5>Interactive Visual Explorer</h5>
  </div>
  </div>
    <div class="vap_container">
        <div class="grid-container fluid">
          <div class="grid-x grid-margin-x">
            <div class="cell">
                <ul class="tabs" data-deep-link="true" data-update-history="true" data-deep-link-smudge="true" data-deep-link-smudge-delay="500" data-tabs id="deeplinked-tabs">
                  <li class="tabs-title is-active"><a href="#serverfile" aria-selected="true">Choose File from Server</a></li>
                  <li class="tabs-title"><a href="#upload">Upload File</a></li>
                {%  if data_is_ready %}
                  <li class="tabs-title"><a href="#print">Print Dataset</a></li>
                  <li class="tabs-title"><a href="#stats">Statistics</a></li>
                  <li class="tabs-title"><a href="#corr">Correlations</a></li>
                {% if cluster_ready %}
                  <li class="tabs-title"><a href="#clusters">Clusters</a></li>
                {% endif %}
                  <li class="tabs-title" style="visibility:hidden" id="multichoicelink"><a href="#multichoice">Chosen Data</a></li>
                {% endif %}
                </ul>

                <div class="tabs-content" data-tabs-content="deeplinked-tabs">
                  {% if dataset_files %}
                  <div class="tabs-panel is-active" id="serverfile">
                    <form action="" method="POST" enctype='multipart/form-data'>
                            {% csrf_token %}
                            <div class="custom-file">
                                  <input type="hidden" name="formt" value="filefromserver">
                                  <select name="filename">
                                      {% for fileonserver in dataset_files %}
                                            {% if filename|safe == fileonserver.value|safe %}
                                                <option value="{{ fileonserver.value|safe }}" selected>{{ fileonserver.name|safe }}</option>
                                            {% else %}
                                                 <option value="{{ fileonserver.value|safe }}">{{ fileonserver.name|safe }}</option>
                                            {% endif %}
                                      {% endfor %}
                                  </select>
                            </div>
                            {% include "LoD_Generator.html" %}
                            <input type="submit" class="button small vap-controllers" value="Submit">
                      </form>
                  </div>
                  {% endif %}
                  <div class="tabs-panel" id="upload">
                    <form action="" method="POST" enctype='multipart/form-data'>
                            {% csrf_token %}
                          <input type="hidden" name="formt" value="newfile">
                          <label for="customFile" class="button small">Upload File</label>
                          <input type="file" id="customFile" class="show-for-sr" name="customFile">
                          {% include "LoD_Generator.html" %}
                          <input type="submit" class="button small" value="Submit">
                     </form>
                  </div>
                {%  if data_is_ready %}
                  <div class="tabs-panel" id="print">
                    <button type="button" class="button small" id="printAllBtn">Display All</button>
                  </div>
                  <div class="tabs-panel" id="stats">
                  </div>
                  <div class="tabs-panel" id="corr">
                    <div id="corr-matrix">
                        <div id="legend"></div>
                    </div>
                  </div>
                  <div class="tabs-panel" id="clusters">
                    <button type="button" class="button small" id="printBtn">Print Results</button>
                  </div>
                  <div class="tabs-panel" id="multichoice">
                  </div>
                {% endif %}
                </div>
            </div>
          </div>
        </div>
          <div class="row">
            <br/>
          </div>
        </div>
        {#<div id="controls"></div> #}
            <div class="grid-x grid-margin-x" style="margin-left: .1000rem;">
              <div class="cell small-3" id="controllers">
                  <div class="grid-y" style="height: 800px;">                  
                    {%  if data_is_ready %}
                      <div class="cell">
                          <div class="card">
                              <div class="card-divider">
                                Dimensions
                              </div>
                              <div class="card-section">
                                <form id="dimensions_form">
                                    <select id="x_dim" style="color:red"></select>
                                    <select id="y_dim" style="color:green"></select>
                                    <select id="z_dim" style="color:blue"></select>
                                    <button type="button" class="button small" id="change_dim_btn">Change Dimensions</button>
                                </form>
                              </div>
                          </div>
                      </div>
                      <div class="cell">
                          <div class="card">
                              <div class="card-divider">
                                Clustering
                              </div>
                              <div class="card-section">
                                <form onsubmit="add_parameters(this);" action="" autocomplete="off" id="cluster_form" method="POST">
                                    {% csrf_token %}
                                    <input type="hidden" name="formt" value="cluster">
                                    {% if saveid %}
                                    <input type="hidden" name="fdid" value="{{ saveid }}">
                                    {% endif %}
                                    {% if filename %}
                                    <input type="hidden" name="fname" value="{{ filename|safe }}">
                                    {% endif %}
                                    <div class="form-group" id="clustering">
                                    </div>
                                    <input type="submit" class="button small" value="Clusterize">
                                </form>
                              </div>
                          </div>
                      </div>
                    {% endif %}
                      <div class="cell large-auto">
                          <div class="card">
                              <div class="card-divider">
                                Visualization Settings
                              </div>
                              <div class="card-section" id='visualizationSettings'>
                              </div>
                            </div>
                        </div>
                    </div>
              </div>
              <div class="cell auto mainPicture" id="picture">
                  <div id="gui_container"></div>
              </div>
            </div>
            </div>
        </div>
{#        <div class="container pre-scrollable" id="output"></div>#}
	</div>
{% block extra_js %}
<script src="{% static "js/three.js" %}"></script>
<script src="{% static "js/controls/OrbitControls.js" %}"></script>
<script src="{% static "js/controls/DragControls.js" %}"></script>
<script src="{% static "js/VAP/sup_func.js" %}"></script>
<script src="{% static "js/VAP/cookies.js" %}"></script>
<script src="{% static "js/VAP/main.js" %}"></script>
<script src="{% static "js/VAP/datavisualization.js" %}"></script>
<script src="{% static "js/dat.gui.min.js" %}"></script>
<script src="{% static "js/VAP/correlation_matrix.js" %}"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="{% static 'js/foundation/vendor/foundation.min.js' %}"></script>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.18/datatables.min.js"></script>
{% endblock %}
	<script>

		function onSceneResize() {
			scene.onResize();
		}

        $(document).ready(function() {
            $('#stats-table').DataTable();

        } );
		var scene = new DataVisualization(document.getElementById("picture"), 0.75);
		animate();
		init();

		window.addEventListener( "resize", onSceneResize, false );

		function init() {

		    var lod_activation = document.getElementById("lod_activation");
		    lod_activation.addEventListener( "click", function(event) {
                    var lod_slider = event.srcElement.ownerDocument.getElementById("lod_slider");
                    var lod_number = event.srcElement.ownerDocument.getElementById("lod_number");
                    if (event.srcElement.checked) {
                        if (lod_slider.classList.contains('disabled')) {
                            lod_slider.classList.remove('disabled');
                        }
                        if (lod_number.style.display === 'none') {
                            lod_number.style.display = 'block';
                        }

                    } else {
                        lod_slider.classList.add('disabled');
                        lod_number.style.display = 'none';
                    }
            });

            {%  if data_is_ready %}
                clustering_parameters=[['KMeans', 'KMeans', {'name':'numberofcl', 'label':'Number of clusters', 'type':'integer', 'attributes':[['placeholder', '5']], 'defvalue':'5', 'min': 1, 'max': 20}],
                                    ['DBSCAN', 'DBSCAN', {'name':'min_samples', 'label':'min_samples','type':'integer', 'attributes':[['placeholder', '5']], 'defvalue':'5', 'min': 1, 'max': 200},
                                                         {'name':'eps', 'label':'epsilon','type':'float', 'attributes':[['placeholder','0.5']], 'defvalue':'0.5', 'min': 0, 'max': 50}
                                                         ]]

            var curr_algorithm;
            var curr_parameters;

            {%  if algorithm %}
            curr_algorithm = "{{ algorithm }}";
            curr_parameters = {{ parameters|safe }};
            {% endif %}

            createClusterElements(document.getElementById('clustering'), document.getElementById('cluster_form'), clustering_parameters, curr_algorithm, curr_parameters);
            {% endif %}

            {% if dim_names %}
            var dimNames = {{ dim_names|safe }};
            scene.setDimNames(dimNames);
            {% endif %}

            {% if index %}
            var index = {{ index|safe }};
            scene.setIndex(index);
            {% endif %}

            {% if norm_dataset %}
            var dataArray = {{ norm_dataset|safe }};
            var new_dataArray = fix_array(dataArray);
            scene.setDataArray(new_dataArray);
            {% endif %}

            {% if real_dataset %}
            var realData = {{ real_dataset|safe }};
            var new_realData = fix_array(realData);
            scene.setRealData(new_realData);
            printDataset(document.getElementById("print"), [index].concat(dimNames), new_realData, 10);
            {% endif %}

            {% if real_metrics %}
            var statistics_real = {{ real_metrics|safe }};
            printStats(statistics_real, dimNames);
            scene.setRealStats(statistics_real);
            {% endif %}

            {% if corr_matrix %}
            var corr_matrix = {{ corr_matrix|safe }};
			Matrix({
				container : '#corr-matrix',
				data      : corr_matrix,
				labels    : dimNames,
				start_color : '#ffffff',
				end_color : '#3498db'
			});
            {% endif %}

            {% if visualparameters %}
            scene.loadParameters({{ visualparameters|safe }});
            {% endif %}

            {% if aux_dataset %}
            var auxData = {{ aux_dataset|safe }};
            var new_auxData = fix_array(auxData);
            scene.setAuxiliaryData(new_auxData);
            var auxNames = {{ aux_names|safe }};
            scene.setAuxiliaryColumns(auxNames);
            {% endif %}

            var lodData = [];
            {% if lod_data %}
            lodData = {{ lod_data|safe }};
            scene.setLOD(lodData);
            {% endif %}

            {% if cluster_ready %}
            var clusters = {{ clusters|safe }};
            scene.setClusters(clusters);
            scene.clusters_color_scheme = getColorScheme(clusters, scene.theme);
            {% else %}
            scene.setClusters([0]);
            scene.clusters_color_scheme = getColorScheme([0], scene.theme);
            {% endif %}
            
			{% if norm_dataset %}
            var objects = [];
			for ( var i = 0; i < new_dataArray.length; i++ ){
                {% if cluster_ready %}
				objects.push(scene.createSphere( new_dataArray[ i ], new_realData[ i ], clusters[ i ], new_auxData[ i ], lodData[ i ] ));
                {% else %}
				objects.push(scene.createSphere( new_dataArray[ i ], new_realData[ i ], 0, new_auxData[ i ], lodData[ i ] ));
				{% endif %}
			}
			{% endif %}
        
            {%  if data_is_ready %}
			scene.createControlElements(document.getElementById('visualizationSettings'), document.getElementById('multichoicelink'), document.getElementById('multichoice'), true);
            {% else %}
			scene.createControlElements(document.getElementById('visualizationSettings'), document.getElementById('multichoicelink'), document.getElementById('multichoice'), false);
            {% endif %}
            
            {% if saveid %}
            scene.setSource('{{ saveid|safe }}');
            {% endif %}

		}

		function animate() {
			scene.animate();
			requestAnimationFrame( animate );
		}

	</script>
{% endblock %}

{% block helptext %}{% endblock %}

